<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SelfGrow - 30天习惯养成计划</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 核心库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFCF8;
            overflow-x: hidden;
        }
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite;
        }
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 核心配置：静态 APP_ID 确保存储键值永久稳定 ---
        const APP_ID = "selfgrow_v3_ultimate"; 

        // --- 存储函数 ---
        const saveToLocal = (key, data) => {
            try {
                localStorage.setItem(`${APP_ID}_${key}`, JSON.stringify(data));
            } catch (e) { console.error(e); }
        };
        const getFromLocal = (key) => {
            const data = localStorage.getItem(`${APP_ID}_${key}`);
            return data ? JSON.parse(data) : null;
        };

        // --- 图标助手 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return (
                <i data-lucide={name} className={`lucide-icon ${className}`} 
                   style={{ width: `${size}px`, height: `${size}px`, strokeWidth: '2px' }}></i>
            );
        };

        // --- AI 调用 ---
        async function fetchAI(prompt, userKey) {
            if (!userKey) return null;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: "你是一个温柔且富有洞察力的心理共鸣伙伴。请确保输出纯文本，严禁使用任何Markdown格式如加粗、斜体或标题。" }] }
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "沉默也是一种回应。";
                } catch (error) {
                    if (i === 4) return null;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        // --- 水彩树绘制 ---
        function WatercolorTree({ dayIndex, completedCount }) {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const w = canvas.clientWidth, h = canvas.clientHeight;
                canvas.width = w * dpr; canvas.height = h * dpr;
                ctx.scale(dpr, dpr);

                const drawTree = (x, y, angle, len, branchWidth, color, depth) => {
                    ctx.beginPath(); ctx.save();
                    ctx.strokeStyle = color; ctx.lineWidth = branchWidth; ctx.lineCap = 'round';
                    ctx.translate(x, y); ctx.rotate(angle * Math.PI / 180);
                    ctx.moveTo(0, 0); ctx.lineTo(0, -len); ctx.stroke();
                    if (depth === 0) {
                        ctx.fillStyle = `rgba(${74 + dayIndex * 4}, ${129 - dayIndex}, ${74}, ${0.4 + (completedCount / 6)})`;
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.ellipse(0, -len, 5 + Math.random() * 5, 8 + Math.random() * 8, Math.random() * Math.PI, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        ctx.restore(); return;
                    }
                    const maxDepth = Math.min(depth, Math.floor(dayIndex / 5) + 2);
                    if (maxDepth > 0) {
                        drawTree(0, -len, angle - (15 + Math.random() * 15), len * 0.75, branchWidth * 0.7, color, depth - 1);
                        drawTree(0, -len, angle + (15 + Math.random() * 15), len * 0.75, branchWidth * 0.7, color, depth - 1);
                    }
                    ctx.restore();
                };
                ctx.clearRect(0, 0, w, h);
                drawTree(w / 2, h - 20, 0, Math.min(20 + dayIndex * 2, 80), Math.min(2 + dayIndex / 4, 10), '#6B705C', 5);
                if (dayIndex >= 25) {
                    ctx.fillStyle = "rgba(255, 182, 193, 0.6)";
                    for (let i = 0; i < 15; i++) {
                        ctx.beginPath(); ctx.arc(w/2 + (Math.random()-0.5)*100, h/2 + (Math.random()-0.5)*100, 3, 0, Math.PI*2); ctx.fill();
                    }
                }
            }, [dayIndex, completedCount]);
            return <canvas ref={canvasRef} className="w-full h-64 md:h-80" />;
        }

        function App() {
            const [view, setView] = useState('loading'); 
            const [userData, setUserData] = useState(null);
            const [dailyRecords, setDailyRecords] = useState({});
            const [archivedCycles, setArchivedCycles] = useState([]);
            const [currentDayIndex, setCurrentDayIndex] = useState(0);
            const [modalContent, setModalContent] = useState(null);

            useEffect(() => {
                const savedUser = getFromLocal('user_config');
                const savedRecords = getFromLocal('daily_records') || {};
                const savedArchives = getFromLocal('archived_cycles') || [];
                setDailyRecords(savedRecords);
                setArchivedCycles(savedArchives);
                if (savedUser) {
                    setUserData(savedUser);
                    const start = new Date(savedUser.startDate); start.setHours(0,0,0,0);
                    const now = new Date(); now.setHours(0,0,0,0);
                    const diff = Math.floor((now.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
                    if (diff >= 30) setView('report');
                    else { setCurrentDayIndex(diff >= 0 ? diff : 0); setView('main'); }
                } else setView('prelude');
            }, []);

            useEffect(() => { if (userData) saveToLocal('user_config', userData); }, [userData]);
            useEffect(() => { if (Object.keys(dailyRecords).length > 0) saveToLocal('daily_records', dailyRecords); }, [dailyRecords]);
            useEffect(() => { saveToLocal('archived_cycles', archivedCycles); }, [archivedCycles]);

            const handleNewJourney = () => {
                const archiveEntry = { config: userData, records: dailyRecords, archivedAt: new Date().toISOString() };
                setArchivedCycles(prev => [archiveEntry, ...prev]);
                setUserData(null);
                saveToLocal('user_config', null);
                setView('prelude');
            };

            if (view === 'loading') return <div className="min-h-screen flex items-center justify-center text-[#A3B18A] font-serif">唤醒森林中...</div>;

            return (
                <div className="min-h-screen bg-[#FDFCF8] text-[#4A4A4A]">
                    {view === 'prelude' && <Prelude onComplete={() => setView('contract')} />}
                    {view === 'contract' && <ContractSetup onSign={(data) => { 
                        const config = { ...data, cycleId: Date.now(), startDate: new Date().toISOString() };
                        setUserData(config); setView('main'); 
                    }} />}
                    {view === 'main' && (
                        <MainDashboard 
                            userData={userData} setUserData={setUserData}
                            dailyRecords={dailyRecords} setDailyRecords={setDailyRecords}
                            currentDay={currentDayIndex}
                            onOpenHistory={() => setView('history')}
                            setModalContent={setModalContent}
                        />
                    )}
                    {view === 'history' && <HistoryView archivedCycles={archivedCycles} dailyRecords={dailyRecords} userData={userData} onBack={() => setView('main')} />}
                    {view === 'report' && <FinalReport userData={userData} dailyRecords={dailyRecords} onReset={handleNewJourney} />}

                    {modalContent && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-[#344E41]/30 backdrop-blur-md" onClick={() => setModalContent(null)} />
                            <div className="bg-white/95 p-8 rounded-[2.5rem] max-w-lg w-full shadow-2xl border border-[#E2E8CE] relative animate-in zoom-in-95 duration-300">
                                <button onClick={() => setModalContent(null)} className="absolute top-6 right-6 p-2 text-[#A3B18A]"><Icon name="x" size={24} /></button>
                                <div className="flex flex-col items-center text-center space-y-6 pt-4">
                                    <div className="p-4 bg-[#F2F4ED] rounded-full"><Icon name="award" size={48} className="text-[#588157]" /></div>
                                    <p className="text-base leading-relaxed italic text-[#588157] px-4">“{modalContent}”</p>
                                    <button onClick={() => setModalContent(null)} className="w-full py-4 bg-[#588157] text-white rounded-2xl font-bold tracking-widest shadow-lg hover:bg-[#344E41] transition-all">收下这份温暖</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 序幕 ---
        function Prelude({ onComplete }) {
            const [text, setText] = useState("");
            const [isFinished, setIsFinished] = useState(false);
            const fullText = "致长期主义者：\n\n在这个碎片化的时代，安静的成长是一种奢侈。\nSelfGrow 不是为了监督，而是为了陪你种下一棵属于自己的树。我们接纳你的波动，只要你还在坚守。\n\n—— 欢迎来到你的森林";
            useEffect(() => {
                let i = 0;
                const interval = setInterval(() => {
                    setText(fullText.slice(0, i)); i++;
                    if (i > fullText.length) { clearInterval(interval); setIsFinished(true); }
                }, 60);
                return () => clearInterval(interval);
            }, []);
            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-10 text-center font-serif">
                    <div className="max-w-prose whitespace-pre-wrap text-xl md:text-2xl leading-relaxed text-[#6B705C]">{text}</div>
                    {isFinished && (
                        <button onClick={onComplete} className="mt-12 px-10 py-4 bg-[#588157] text-white rounded-2xl hover:bg-[#344E41] transition-all font-bold tracking-widest shadow-lg flex items-center gap-2 animate-in fade-in duration-1000">
                            开启成长计划 <Icon name="chevron-right" size={20} />
                        </button>
                    )}
                </div>
            );
        }

        // --- 签署页面 ---
        function ContractSetup({ onSign }) {
            const [form, setForm] = useState({
                tasks: [{ id: 1, name: "", intention: "" }, { id: 2, name: "", intention: "" }, { id: 3, name: "", intention: "" }],
                apiKey: ""
            });
            const isComplete = form.tasks.every(t => t.name && t.intention);
            return (
                <div className="max-w-2xl mx-auto py-20 px-6 min-h-screen flex flex-col justify-center animate-in fade-in duration-700">
                    <div className="mb-12 text-center">
                        <h2 className="text-3xl font-serif text-[#344E41] mb-2">签署新的成长契约</h2>
                        <p className="text-[#A3B18A]">设定你的成长支点，开启 30 天的坚守。</p>
                    </div>
                    <div className="space-y-8 bg-white/50 p-8 rounded-3xl border border-[#E2E8CE]">
                        {form.tasks.map((task, idx) => (
                            <div key={idx} className="space-y-3">
                                <div className="flex items-center gap-3">
                                    <span className="w-8 h-8 rounded-full bg-[#DAD7CD] flex items-center justify-center text-[#588157] font-bold shrink-0">{idx + 1}</span>
                                    <input placeholder="想要养成的习惯 (如：早起)" className="flex-1 bg-transparent border-b border-[#DAD7CD] py-2 outline-none focus:border-[#A3B18A]" 
                                           value={task.name} onChange={e => { const nt = [...form.tasks]; nt[idx].name = e.target.value; setForm({...form, tasks: nt}); }} />
                                </div>
                                <input placeholder="你的初心 (为什么要坚持这件事?)" className="w-full bg-transparent border-b border-[#DAD7CD] py-1 pl-11 text-sm text-[#6B705C] italic outline-none"
                                       value={task.intention} onChange={e => { const nt = [...form.tasks]; nt[idx].intention = e.target.value; setForm({...form, tasks: nt}); }} />
                            </div>
                        ))}
                        <div className="pt-6 border-t border-[#E2E8CE]">
                            <label className="block text-xs uppercase tracking-widest text-[#A3B18A] mb-2 font-bold">Gemini API Key (选填)</label>
                            <input type="password" placeholder="填写 Key 解锁 AI 互动" className="w-full bg-[#FDFCF8] rounded-xl px-4 py-3 border border-[#DAD7CD] outline-none focus:ring-1 focus:ring-[#A3B18A]"
                                   value={form.apiKey} onChange={e => setForm({...form, apiKey: e.target.value})} />
                        </div>
                        <button disabled={!isComplete} onClick={() => onSign(form)}
                                className={`w-full py-4 rounded-2xl font-bold tracking-widest transition-all ${isComplete ? 'bg-[#588157] text-white shadow-lg' : 'bg-[#DAD7CD] text-white cursor-not-allowed'}`}>
                            正式签署
                        </button>
                    </div>
                </div>
            );
        }

        // --- 主面板 ---
        function MainDashboard({ userData, setUserData, dailyRecords, currentDay, setDailyRecords, onOpenHistory, setModalContent }) {
            const [quote, setQuote] = useState("成长的秘诀在于持续。 —— SelfGrow");
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const todayKey = `${userData.cycleId}_day_${currentDay}`;
            const todayRecord = dailyRecords[todayKey] || { tasks: [false, false, false], times: [0, 0, 0], journal: "", whispers: ["", "", ""], journalSubmitted: false, fullDayEncouraged: false };

            const isDailyFull = todayRecord.tasks.every(t => t);

            // 获取真实名人名言
            useEffect(() => {
                const fetchDailyQuote = async () => {
                    const q = await fetchAI("请随机生成一句真实存在、极具激励深意的中文名人名言。格式必须为：名言内容 —— 名人姓名。严禁使用Markdown格式。", userData.apiKey);
                    if (q) setQuote(q);
                };
                fetchDailyQuote();
            }, [currentDay, userData.apiKey]);

            // 全打卡自动正反馈
            useEffect(() => {
                if (isDailyFull && !todayRecord.fullDayEncouraged && userData.apiKey) {
                    const getEncouragement = async () => {
                        const feedback = await fetchAI("今日所有任务已圆满完成。请作为共鸣伙伴，给用户一段极其温柔、富有诗意的简短鼓励（80字以内），不带Markdown。", userData.apiKey);
                        if (feedback) {
                            setModalContent(feedback);
                            updateToday({ fullDayEncouraged: true });
                        }
                    };
                    getEncouragement();
                }
            }, [isDailyFull, todayRecord.fullDayEncouraged]);

            const updateToday = (updates) => setDailyRecords(prev => ({ ...prev, [todayKey]: { ...(prev[todayKey] || todayRecord), ...updates } }));

            const handleToggle = async (idx) => {
                if (todayRecord.tasks[idx]) return;
                const nt = [...todayRecord.tasks]; nt[idx] = true;
                
                // 优化后的贴合任务内容的 AI 反馈
                let whisper = "";
                if (userData.apiKey) {
                    whisper = await fetchAI(`用户刚刚完成了计划中的任务“${userData.tasks[idx].name}”，其初心是“${userData.tasks[idx].intention}”。请根据这个特定的任务内容和初衷，写一句极其简短（10字以内）、有力且贴合语境的正向反馈。严禁Markdown。`, userData.apiKey);
                }
                
                const nw = [...todayRecord.whispers]; nw[idx] = whisper;
                updateToday({ tasks: nt, whispers: nw });
            };

            const totalTime = useMemo(() => Object.entries(dailyRecords)
                .filter(([k]) => k.startsWith(String(userData.cycleId)))
                .reduce((acc, [, v]) => acc + (v.times?.reduce((a, b) => a + Number(b), 0) || 0), 0), [dailyRecords, userData.cycleId]);

            return (
                <div className="max-w-5xl mx-auto px-4 py-8 space-y-8 animate-in slide-in-from-bottom-4 duration-700">
                    <header className={`relative bg-white/40 rounded-[2.5rem] p-8 border border-[#E2E8CE] transition-all duration-1000 ${isDailyFull ? 'brightness-95' : ''}`}>
                        <div className="flex justify-between items-start">
                            <div><h1 className="text-2xl font-serif text-[#344E41]">SelfGrow 30天养成计划</h1><span className="text-xs text-[#A3B18A] tracking-widest font-bold">DAY {currentDay + 1} OF 30</span></div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 bg-white/60 rounded-full shadow-sm hover:bg-white transition-all"><Icon name="settings" size={20} className="text-[#A3B18A]" /></button>
                                <button onClick={onOpenHistory} className="p-2 bg-white/60 rounded-full shadow-sm hover:bg-white transition-all"><Icon name="clock" size={20} className="text-[#588157]" /></button>
                            </div>
                        </div>
                        <WatercolorTree dayIndex={currentDay} completedCount={todayRecord.tasks.filter(Boolean).length} />
                        
                        <div className="text-center mt-6 italic text-sm text-[#6B705C] max-w-md mx-auto transition-all duration-500">
                            {isDailyFull ? (
                                <span className="text-[#588157] font-medium tracking-wide">今日任务已圆满完成，明天再见。</span>
                            ) : (
                                <span>{quote}</span>
                            )}
                        </div>
                        
                        {isDailyFull && (
                            <div className="absolute inset-0 flex items-center justify-center bg-white/5 backdrop-blur-[1px] rounded-[2.5rem] pointer-events-none">
                                <span className="bg-white/90 px-6 py-2 rounded-full text-[#588157] font-medium border border-[#E2E8CE] shadow-sm animate-in zoom-in duration-500">今日圆满</span>
                            </div>
                        )}
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <section className="bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE]">
                            <h3 className="font-serif text-lg text-[#344E41] mb-6">核心成长</h3>
                            <div className="space-y-4">
                                {userData.tasks.map((task, idx) => (
                                    <div key={idx} className={`flex items-center gap-4 p-5 rounded-2xl transition-all border ${todayRecord.tasks[idx] ? 'bg-[#E2E8CE]/20 border-[#E2E8CE]/40' : 'hover:bg-white/50 border-transparent'}`}>
                                        <button onClick={() => handleToggle(idx)} className={`transition-transform active:scale-90 ${todayRecord.tasks[idx] ? 'text-[#588157]' : 'text-[#DAD7CD]'}`}>
                                            <Icon name={todayRecord.tasks[idx] ? "check-circle-2" : "circle"} size={32} />
                                        </button>
                                        <div className="flex-1 min-w-0">
                                            <span className={`block font-medium truncate ${todayRecord.tasks[idx] ? 'line-through text-[#A3B18A]' : 'text-[#344E41]'}`}>{task.name}</span>
                                            <p className="text-xs text-[#6B705C] italic truncate truncate max-w-[150px]">“{task.intention}”</p>
                                            {todayRecord.whispers[idx] && (
                                                <p className="text-[11px] text-[#588157] font-medium pt-1 animate-in fade-in slide-in-from-left-2">{todayRecord.whispers[idx]}</p>
                                            )}
                                        </div>
                                        <div className={`shrink-0 w-16 h-16 flex flex-col items-center justify-center rounded-2xl border transition-all ${todayRecord.tasks[idx] ? 'bg-transparent border-transparent' : 'bg-[#F2F4ED] border-[#E2E8CE]/50'}`}>
                                            <span className="text-[9px] text-[#A3B18A] font-bold">MIN</span>
                                            <input type="number" readOnly={todayRecord.tasks[idx]} className={`w-full bg-transparent text-center font-serif text-xl outline-none ${todayRecord.tasks[idx] ? 'opacity-30' : 'focus:text-[#588157]'}`} 
                                                   value={todayRecord.times[idx] || ""} onChange={e => { const nt = [...todayRecord.times]; nt[idx] = e.target.value; updateToday({times: nt}); }} />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        <section className="bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE]">
                            <h3 className="font-serif text-lg text-[#344E41] mb-6">时光足迹</h3>
                            <div className="grid grid-cols-6 gap-3 mb-8">
                                {[...Array(30)].map((_, i) => {
                                    const rec = dailyRecords[`${userData.cycleId}_day_${i}`];
                                    const done = rec?.tasks?.filter(Boolean).length || 0;
                                    const isFuture = i > currentDay;
                                    let bg = i === currentDay ? 'ring-2 ring-[#A3B18A] bg-white shadow-sm' : (done === 3 ? 'bg-[#588157] text-white' : (done > 0 ? 'bg-[#A3B18A]/60' : (isFuture ? 'bg-[#DAD7CD]/20' : 'bg-[#BDBDBA]/50')));
                                    return <div key={i} className={`w-10 h-10 rounded-full flex items-center justify-center text-[10px] font-bold transition-all ${bg} ${done === 3 ? 'text-white' : 'text-[#6B705C]'}`}>{i + 1}</div>;
                                })}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-[#E2E8CE]/30 p-4 rounded-2xl shadow-inner"><p className="text-[10px] font-bold text-[#A3B18A] uppercase tracking-widest">Today</p><p className="text-xl font-serif text-[#344E41]">{todayRecord.times.reduce((a,b)=>a+Number(b),0)} min</p></div>
                                <div className="bg-[#A3B18A]/10 p-4 rounded-2xl shadow-inner"><p className="text-[10px] font-bold text-[#A3B18A] uppercase tracking-widest">Total</p><p className="text-xl font-serif text-[#344E41]">{totalTime} min</p></div>
                            </div>
                        </section>
                    </div>

                    <footer className={`bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE] transition-all duration-700 ${todayRecord.journalSubmitted ? 'opacity-70' : ''}`}>
                        <div className="flex items-baseline gap-4 mb-4">
                            <h3 className="font-serif text-lg text-[#344E41]">心灵留白</h3>
                            {/* 优化后的整句引导语 */}
                            <span className="text-[10px] text-[#A3B18A] font-light italic">
                                {todayRecord.journalSubmitted ? '今日复盘已封存' : '三段式复盘：10min记录事实、10min深度提问、10min写下结论。'}
                            </span>
                        </div>
                        <textarea readOnly={todayRecord.journalSubmitted} className="w-full h-32 bg-transparent outline-none resize-none text-[#6B705C] placeholder:text-[#DAD7CD] leading-relaxed no-scrollbar" placeholder="此时此刻，你在想什么..."
                                  value={todayRecord.journal} onChange={e => updateToday({ journal: e.target.value })} />
                        <div className="flex justify-end mt-4">
                            <button disabled={todayRecord.journalSubmitted} onClick={() => { updateToday({ journalSubmitted: true }); setModalContent("存入成功，愿文字带给你成长的力量。"); }}
                                    className={`px-8 py-2.5 rounded-full text-sm flex items-center gap-2 transition-all shadow-md ${todayRecord.journalSubmitted ? 'bg-[#DAD7CD] text-[#6B705C] cursor-not-allowed shadow-none' : 'bg-[#344E41] text-white hover:bg-[#3A5A40] shadow-[#344E41]/20'}`}>
                                <Icon name={todayRecord.journalSubmitted ? "lock" : "send"} size={14} /> {todayRecord.journalSubmitted ? '已封存' : '存入森林'}
                            </button>
                        </div>
                    </footer>

                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-black/10 backdrop-blur-sm" onClick={() => setIsSettingsOpen(false)} />
                            <div className="bg-white p-8 rounded-[2rem] max-w-sm w-full shadow-2xl relative animate-in zoom-in-95 duration-200">
                                <h4 className="text-xl font-serif text-[#344E41] mb-6 flex items-center gap-2"><Icon name="settings" size={20} /> 系统设置</h4>
                                <input type="password" placeholder="Gemini API Key" className="w-full bg-[#FDFCF8] rounded-xl px-4 py-3 border border-[#DAD7CD] mb-4 outline-none focus:ring-1 focus:ring-[#A3B18A]" 
                                       defaultValue={userData.apiKey} onBlur={e => setUserData({...userData, apiKey: e.target.value})} />
                                <button onClick={() => setIsSettingsOpen(false)} className="w-full py-3 bg-[#588157] text-white rounded-xl font-bold hover:bg-[#344E41] transition-all">确认</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 历史记录 ---
        function HistoryView({ archivedCycles, dailyRecords, userData, onBack }) { 
            const [selectedCycleId, setSelectedCycleId] = useState(userData.cycleId);
            const [selectedDay, setSelectedDay] = useState(0);
            const activeConfig = selectedCycleId === userData.cycleId ? userData : archivedCycles.find(c => c.config.cycleId === selectedCycleId)?.config;
            const record = dailyRecords[`${selectedCycleId}_day_${selectedDay}`];
            return (
                <div className="max-w-4xl mx-auto px-6 py-12 min-h-screen animate-in fade-in duration-500">
                    <button onClick={onBack} className="flex items-center gap-2 text-[#A3B18A] hover:text-[#588157] mb-10 font-medium transition-colors"><Icon name="arrow-left" size={20} /> 返回当前森林</button>
                    <div className="mb-8">
                        <label className="text-xs uppercase tracking-widest text-[#A3B18A] block mb-2 font-bold">选择成长周期</label>
                        <select className="bg-white border border-[#E2E8CE] rounded-xl px-4 py-2 outline-none text-sm text-[#344E41]" value={selectedCycleId} onChange={e => setSelectedCycleId(Number(e.target.value))}>
                            <option value={userData.cycleId}>当前周期</option>
                            {archivedCycles.map((c, i) => (
                                <option key={i} value={c.config.cycleId}>往期周期 ({new Date(c.config.startDate).toLocaleDateString()})</option>
                            ))}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                        <div className="space-y-4">
                            <h2 className="text-2xl font-serif text-[#344E41]">时光回响</h2>
                            <div className="grid grid-cols-5 gap-3">
                                {[...Array(30)].map((_, i) => (
                                    <button key={i} onClick={() => setSelectedDay(i)}
                                            className={`w-full aspect-square rounded-xl flex items-center justify-center text-xs transition-all ${selectedDay === i ? 'bg-[#344E41] text-white shadow-lg' : 'bg-[#E2E8CE]/40'}`}>
                                        {i + 1}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="md:col-span-2 bg-white/80 rounded-3xl p-8 border border-[#E2E8CE] shadow-sm">
                            {record ? (
                                <div className="space-y-6">
                                    <h4 className="text-xl font-serif text-[#344E41]">DAY {selectedDay + 1} 定格</h4>
                                    {activeConfig.tasks.map((task, idx) => (
                                        <div key={idx} className="flex flex-col p-3 rounded-xl bg-[#FDFCF8] border border-[#E2E8CE]/30">
                                            <div className="flex items-center gap-2">
                                                <Icon name={record.tasks[idx] ? "check-circle-2" : "circle"} size={18} className={record.tasks[idx] ? "text-[#588157]" : "text-[#DAD7CD]"} />
                                                <span className="text-sm font-medium">{task.name}</span>
                                            </div>
                                            <span className="pl-7 text-[10px] text-[#A3B18A]">专注: {record.times[idx] || 0} min</span>
                                        </div>
                                    ))}
                                    <div className="pt-4 border-t border-[#F0F0F0] italic text-[#6B705C] text-sm leading-relaxed">“{record.journal || "那日无留白。"}”</div>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-64 text-[#DAD7CD]"><Icon name="calendar" size={48} /><p className="mt-4">未见轨迹</p></div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 周期结语报告 ---
        function FinalReport({ userData, dailyRecords, onReset }) { 
            return (
                <div className="max-w-3xl mx-auto py-16 px-6 animate-in fade-in duration-1000">
                    <div className="bg-white p-12 rounded-[3rem] shadow-xl border border-[#E2E8CE]">
                        <h2 className="text-3xl font-serif text-[#344E41] mb-8 text-center">30天成长见证</h2>
                        <div className="text-[#6B705C] leading-loose italic text-center px-4">恭喜你走完了这 30 天。过去的每一份努力都已化作森林的根基。点击下方开启新旅程，往期记录将完整保留在时光回响中。</div>
                        <div className="mt-16 flex flex-col items-center">
                            <button onClick={onReset} className="px-12 py-4 bg-[#344E41] text-white rounded-2xl font-bold shadow-lg hover:scale-105 transition-transform uppercase tracking-widest">开启新周期</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>