<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SelfGrow - 30天成长契约</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 核心库 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #FDFCF8;
        }
        .font-serif {
            font-family: 'Noto Serif SC', serif;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s infinite;
        }
        /* 修复 Lucide 图标在 flex 布局下的对齐 */
        .lucide-icon {
            display: inline-block;
            vertical-align: middle;
        }
        /* 隐藏滚动条但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- 配置与常量 ---
        const API_KEY = ""; 
        const APP_ID = "selfgrow-v3-3"; 

        // --- 辅助工具 ---
        const saveToLocal = (key, data) => localStorage.setItem(`${API_KEY}_${key}`, JSON.stringify(data));
        const getFromLocal = (key) => {
            const data = localStorage.getItem(`${API_KEY}_${key}`);
            return data ? JSON.parse(data) : null;
        };

        // --- 图标组件助手 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);

            return (
                <i 
                    data-lucide={name} 
                    className={`lucide-icon ${className}`} 
                    style={{ width: `${size}px`, height: `${size}px`, strokeWidth: '2px' }}
                ></i>
            );
        };

        // --- AI 调用函数 ---
        async function fetchAI(prompt, userKey, systemPrompt = "你是一个温柔且富有洞察力的心理共鸣伙伴。") {
            const apiKey = userKey || API_KEY;
            if (!apiKey) return null;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    });
                    if (!response.ok) throw new Error('API Error');
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "沉默也是一种回应。";
                } catch (error) {
                    if (i === 4) return "连接森林的信号有些弱，但你的努力已被记住。";
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        // --- 子组件: 水彩树 Canvas ---
        function WatercolorTree({ dayIndex, completedCount }) {
            const canvasRef = useRef(null);
            
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const w = canvas.clientWidth;
                const h = canvas.clientHeight;
                canvas.width = w * dpr;
                canvas.height = h * dpr;
                ctx.scale(dpr, dpr);

                const drawTree = (x, y, angle, len, branchWidth, color, depth) => {
                    ctx.beginPath();
                    ctx.save();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = branchWidth;
                    ctx.lineCap = 'round';
                    ctx.translate(x, y);
                    ctx.rotate(angle * Math.PI / 180);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(0, -len);
                    ctx.stroke();

                    if (depth === 0) {
                        const leafColor = `rgba(${74 + dayIndex * 4}, ${129 - dayIndex}, ${74}, ${0.4 + (completedCount / 6)})`;
                        ctx.fillStyle = leafColor;
                        for (let i = 0; i < 3; i++) {
                            ctx.beginPath();
                            ctx.ellipse(0, -len, 5 + Math.random() * 5, 8 + Math.random() * 8, Math.random() * Math.PI, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        ctx.restore();
                        return;
                    }

                    const maxDepth = Math.min(depth, Math.floor(dayIndex / 5) + 2);
                    if (maxDepth > 0) {
                        drawTree(0, -len, angle - (15 + Math.random() * 15), len * 0.75, branchWidth * 0.7, color, depth - 1);
                        drawTree(0, -len, angle + (15 + Math.random() * 15), len * 0.75, branchWidth * 0.7, color, depth - 1);
                    }
                    ctx.restore();
                };

                ctx.clearRect(0, 0, w, h);
                const trunkLen = Math.min(20 + dayIndex * 2, 80);
                const trunkWidth = Math.min(2 + dayIndex / 4, 10);
                drawTree(w / 2, h - 20, 0, trunkLen, trunkWidth, '#6B705C', 5);

                if (dayIndex >= 25) {
                    ctx.fillStyle = "rgba(255, 182, 193, 0.6)";
                    for (let i = 0; i < 15; i++) {
                        ctx.beginPath();
                        ctx.arc(w/2 + (Math.random()-0.5)*100, h/2 + (Math.random()-0.5)*100, 3, 0, Math.PI*2);
                        ctx.fill();
                    }
                }
            }, [dayIndex, completedCount]);

            return <canvas ref={canvasRef} className="w-full h-64 md:h-80 cursor-pointer active:scale-[0.98] transition-transform" />;
        }

        // --- 主应用逻辑 ---
        function App() {
            const [view, setView] = useState('loading'); 
            const [userData, setUserData] = useState(null);
            const [dailyRecords, setDailyRecords] = useState({});
            const [currentDayIndex, setCurrentDayIndex] = useState(0);
            const [modalContent, setModalContent] = useState(null);

            useEffect(() => {
                const savedUser = getFromLocal('user_config');
                const savedRecords = getFromLocal('daily_records') || {};
                
                if (savedUser) {
                    setUserData(savedUser);
                    setDailyRecords(savedRecords);
                    const startDate = new Date(savedUser.startDate);
                    const today = new Date();
                    const diffDays = Math.floor(Math.abs(today - startDate) / (1000 * 60 * 60 * 24));
                    if (diffDays >= 30) setView('report');
                    else { setCurrentDayIndex(diffDays); setView('main'); }
                } else {
                    setView('prelude');
                }
            }, []);

            useEffect(() => {
                if (userData) saveToLocal('user_config', userData);
                if (Object.keys(dailyRecords).length > 0) saveToLocal('daily_records', dailyRecords);
            }, [userData, dailyRecords]);

            if (view === 'loading') return <div className="min-h-screen flex items-center justify-center text-[#A3B18A] font-serif">唤醒森林中...</div>;

            return (
                <div className="min-h-screen bg-[#FDFCF8] text-[#4A4A4A]">
                    {view === 'prelude' && <Prelude onComplete={() => setView('contract')} />}
                    {view === 'contract' && <ContractSetup onSign={(data) => { setUserData(data); setView('main'); }} />}
                    {view === 'main' && (
                        <MainDashboard 
                            userData={userData} 
                            setUserData={setUserData}
                            dailyRecords={dailyRecords} 
                            currentDay={currentDayIndex}
                            setDailyRecords={setDailyRecords}
                            onOpenHistory={() => setView('history')}
                            setModalContent={setModalContent}
                        />
                    )}
                    {view === 'history' && <HistoryView dailyRecords={dailyRecords} userData={userData} onBack={() => setView('main')} />}
                    {view === 'report' && <FinalReport userData={userData} dailyRecords={dailyRecords} onReset={() => { localStorage.clear(); window.location.reload(); }} />}

                    {/* 弹窗层 */}
                    {modalContent && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-[#344E41]/30 backdrop-blur-md" onClick={() => setModalContent(null)} />
                            <div className="bg-white/95 p-8 rounded-[2.5rem] max-w-lg w-full shadow-2xl border border-[#E2E8CE] relative animate-in zoom-in-95 duration-300">
                                <button onClick={() => setModalContent(null)} className="absolute top-6 right-6 p-2 text-[#A3B18A] hover:text-[#344E41] transition-colors"><Icon name="x" size={24} /></button>
                                <div className="flex flex-col items-center text-center space-y-6 pt-4">
                                    <div className="p-4 bg-[#F2F4ED] rounded-full"><Icon name="award" size={48} className="text-[#588157]" /></div>
                                    <div className="space-y-4">
                                        <h4 className="text-xl font-serif text-[#344E41]">森林的馈赠</h4>
                                        <p className="text-base leading-relaxed italic text-[#588157]">“{modalContent}”</p>
                                    </div>
                                    <button onClick={() => setModalContent(null)} className="w-full py-4 bg-[#588157] text-white rounded-2xl font-bold tracking-widest shadow-lg hover:bg-[#344E41] transition-all">收下这份温暖</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 序幕组件 ---
        function Prelude({ onComplete }) {
            const [text, setText] = useState("");
            const [isFinished, setIsFinished] = useState(false);
            const fullText = "致长期主义者：\n\n在这个碎片化的时代，安静的成长是一种奢侈。\nSelfGrow 不是为了监督，而是为了陪你种下一棵属于自己的树。我们接纳你的波动，只要你还在坚守。\n\n—— 欢迎来到你的森林";
            
            useEffect(() => {
                let i = 0;
                const interval = setInterval(() => {
                    setText(fullText.slice(0, i));
                    i++;
                    if (i > fullText.length) { clearInterval(interval); setIsFinished(true); }
                }, 60);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="flex flex-col items-center justify-center min-h-screen px-10 text-center">
                    <div className="max-w-prose whitespace-pre-wrap text-xl md:text-2xl leading-relaxed text-[#6B705C] font-serif">
                        {text}
                        {!isFinished && <span className="inline-block w-1 h-6 bg-[#A3B18A] ml-1 animate-pulse" />}
                    </div>
                    {isFinished && (
                        <button onClick={onComplete} className="mt-12 px-10 py-4 bg-[#588157] text-white rounded-2xl hover:bg-[#344E41] transition-all font-bold tracking-[0.2em] shadow-lg flex items-center gap-2 group animate-in fade-in slide-in-from-bottom-4 duration-1000">
                            开启成长计划 <Icon name="chevron-right" size={20} className="group-hover:translate-x-1 transition-transform" />
                        </button>
                    )}
                </div>
            );
        }

        // --- 契约初始化 ---
        function ContractSetup({ onSign }) {
            const [form, setForm] = useState({
                tasks: [{ id: 1, name: "", intention: "" }, { id: 2, name: "", intention: "" }, { id: 3, name: "", intention: "" }],
                apiKey: ""
            });

            const isComplete = form.tasks.every(t => t.name && t.intention);

            return (
                <div className="max-w-2xl mx-auto py-20 px-6 min-h-screen flex flex-col justify-center animate-in fade-in duration-700">
                    <div className="mb-12 text-center">
                        <h2 className="text-3xl font-serif text-[#344E41] mb-2">成长契约初始化</h2>
                        <p className="text-[#A3B18A]">设定你的成长支点，开启 30 天的坚守。</p>
                    </div>
                    <div className="space-y-8 bg-white/50 p-8 rounded-3xl border border-[#E2E8CE]">
                        {form.tasks.map((task, idx) => (
                            <div key={idx} className="space-y-3">
                                <div className="flex items-center gap-3">
                                    <span className="w-8 h-8 rounded-full bg-[#DAD7CD] flex items-center justify-center text-[#588157] font-bold shrink-0">{idx + 1}</span>
                                    <input placeholder="想要养成的习惯" className="flex-1 bg-transparent border-b border-[#DAD7CD] py-2 outline-none focus:border-[#A3B18A] transition-colors" 
                                           value={task.name} onChange={e => {
                                               const nt = [...form.tasks]; nt[idx].name = e.target.value; setForm({...form, tasks: nt});
                                           }} />
                                </div>
                                <input placeholder="你的初心" className="w-full bg-transparent border-b border-[#DAD7CD] py-1 pl-11 text-sm text-[#6B705C] italic outline-none focus:border-[#A3B18A] transition-colors"
                                       value={task.intention} onChange={e => {
                                           const nt = [...form.tasks]; nt[idx].intention = e.target.value; setForm({...form, tasks: nt});
                                       }} />
                            </div>
                        ))}
                        <div className="pt-6 border-t border-[#E2E8CE]">
                            <label className="block text-xs uppercase tracking-widest text-[#A3B18A] mb-2">Gemini API Key (选填)</label>
                            <input type="password" placeholder="输入你的 API Key" className="w-full bg-[#FDFCF8] rounded-xl px-4 py-3 border border-[#DAD7CD] outline-none focus:ring-1 focus:ring-[#A3B18A]"
                                   value={form.apiKey} onChange={e => setForm({...form, apiKey: e.target.value})} />
                            <p className="mt-2 text-[11px] text-[#A3B18A] leading-relaxed">
                                <Icon name="sparkles" size={12} className="mr-1 opacity-60" />
                                填写 Key 后可解锁更深度 AI 交互，如每日密语、森林鼓励及月末深度复盘。
                            </p>
                        </div>
                        <button disabled={!isComplete} onClick={() => onSign({...form, startDate: new Date().toISOString()})}
                                className={`w-full py-4 rounded-2xl font-bold tracking-widest transition-all ${isComplete ? 'bg-[#588157] text-white shadow-lg hover:bg-[#344E41]' : 'bg-[#DAD7CD] text-white cursor-not-allowed'}`}>
                            签署契约，正式启程
                        </button>
                    </div>
                </div>
            );
        }

        // --- 主面板 ---
        function MainDashboard({ userData, setUserData, dailyRecords, currentDay, setDailyRecords, onOpenHistory, setModalContent }) {
            const [quote, setQuote] = useState("成长的秘诀在于持续。");
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [tempApiKey, setTempApiKey] = useState(userData.apiKey || "");
            
            const todayKey = `day_${currentDay}`;
            const todayRecord = dailyRecords[todayKey] || { tasks: [false, false, false], times: [0, 0, 0], journal: "", skips: 0, whispers: ["", "", ""], journalSubmitted: false };

            useEffect(() => {
                const fetchDailyQuote = async () => {
                    const q = await fetchAI("为今天的成长写一句名言金句，格式为：名言内容 —— 名人姓名", userData.apiKey);
                    if (q) setQuote(q);
                };
                fetchDailyQuote();
            }, [currentDay, userData.apiKey]);

            const updateToday = (updates) => {
                setDailyRecords(prev => ({
                    ...prev,
                    [todayKey]: { ...todayRecord, ...updates }
                }));
            };

            const handleTaskToggle = async (idx) => {
                if (todayRecord.tasks[idx]) return;
                const newTasks = [...todayRecord.tasks]; newTasks[idx] = true;
                
                let whisper = "";
                if (userData.apiKey) {
                    whisper = await fetchAI(`用户完成了“${userData.tasks[idx].name}”，写一句极简鼓励语。`, userData.apiKey);
                }
                
                const nw = [...todayRecord.whispers]; nw[idx] = whisper;
                updateToday({ tasks: newTasks, whispers: nw });
            };

            const saveSettings = () => {
                setUserData({ ...userData, apiKey: tempApiKey });
                setIsSettingsOpen(false);
            };

            const totalTime = useMemo(() => Object.values(dailyRecords).reduce((acc, rec) => acc + (rec.times?.reduce((a, b) => a + Number(b), 0) || 0), 0), [dailyRecords]);
            const todayTotalTime = todayRecord.times.reduce((a, b) => a + Number(b), 0);
            const isDailyFull = todayRecord.tasks.every(t => t);

            return (
                <div className="max-w-5xl mx-auto px-4 py-8 space-y-8 animate-in slide-in-from-bottom-4 duration-700">
                    <header className={`relative bg-white/40 rounded-[2.5rem] p-8 border border-[#E2E8CE] transition-all duration-1000 ${isDailyFull ? 'brightness-95' : ''}`}>
                        <div className="flex justify-between items-start mb-4">
                            <div><h1 className="text-2xl font-serif text-[#344E41]">SelfGrow 30天习惯养成计划</h1><span className="text-xs text-[#A3B18A] tracking-widest font-bold">DAY {currentDay + 1} OF 30</span></div>
                            <div className="flex gap-2">
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 bg-white/60 rounded-full shadow-sm hover:bg-white transition-all"><Icon name="settings" size={20} className="text-[#A3B18A]" /></button>
                                <button onClick={onOpenHistory} className="p-2 bg-white/60 rounded-full shadow-sm hover:bg-white transition-all"><Icon name="clock" size={20} className="text-[#588157]" /></button>
                            </div>
                        </div>
                        <WatercolorTree dayIndex={currentDay} completedCount={todayRecord.tasks.filter(Boolean).length} />
                        <div className="text-center mt-6 italic text-sm text-[#6B705C] max-w-md mx-auto">{quote}</div>
                        {isDailyFull && <div className="absolute inset-0 flex items-center justify-center bg-white/5 backdrop-blur-[1px] rounded-[2.5rem] pointer-events-none"><span className="bg-white/90 px-6 py-2 rounded-full text-[#588157] font-medium border border-[#E2E8CE] shadow-sm">今日圆满</span></div>}
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <section className="bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE]">
                            <h3 className="font-serif text-lg text-[#344E41] mb-6">核心成长</h3>
                            <div className="space-y-6">
                                {userData.tasks.map((task, idx) => (
                                    <div key={idx} className={`flex items-center gap-4 p-5 rounded-[1.5rem] transition-all border border-transparent ${todayRecord.tasks[idx] ? 'bg-[#E2E8CE]/20 border-[#E2E8CE]/40' : 'hover:bg-white/50 hover:border-[#E2E8CE]/30'}`}>
                                        <button onClick={() => handleTaskToggle(idx)} disabled={todayRecord.tasks[idx]} className={`transition-transform active:scale-90 ${todayRecord.tasks[idx] ? 'text-[#588157]' : 'text-[#DAD7CD]'}`}>
                                            <Icon name={todayRecord.tasks[idx] ? "check-circle-2" : "circle"} size={32} />
                                        </button>
                                        
                                        <div className="flex-1 min-w-0">
                                            <div className="flex flex-col">
                                                <span className={`text-base font-medium truncate ${todayRecord.tasks[idx] ? 'line-through text-[#A3B18A]' : 'text-[#344E41]'}`}>{task.name}</span>
                                                <p className="text-xs text-[#6B705C] italic truncate max-w-[150px] sm:max-w-none">“{task.intention}”</p>
                                                {todayRecord.whispers[idx] && <p className="text-[11px] text-[#588157] font-medium pt-1 animate-in fade-in slide-in-from-left-2">{todayRecord.whispers[idx]}</p>}
                                            </div>
                                        </div>

                                        {/* 优化后的右侧时间录入区 */}
                                        <div className={`shrink-0 w-16 h-16 flex flex-col items-center justify-center rounded-2xl border transition-all ${todayRecord.tasks[idx] ? 'bg-transparent border-transparent' : 'bg-[#F2F4ED] border-[#E2E8CE]/50 shadow-sm'}`}>
                                            <span className="text-[9px] uppercase tracking-tighter text-[#A3B18A] font-bold">MIN</span>
                                            <input 
                                                type="number" 
                                                readOnly={todayRecord.tasks[idx]} 
                                                className={`w-full bg-transparent text-xl font-serif text-center outline-none ${todayRecord.tasks[idx] ? 'opacity-30' : 'focus:text-[#588157]'}`} 
                                                placeholder="0"
                                                value={todayRecord.times[idx] || ""} 
                                                onChange={e => { const nt = [...todayRecord.times]; nt[idx] = e.target.value; updateToday({times: nt}); }} 
                                            />
                                        </div>
                                    </div>
                                ))}
                            </div>
                            {isDailyFull && (
                                userData.apiKey ? (
                                    <button onClick={async () => setModalContent(await fetchAI("今日全勤，写一段温柔夸奖。", userData.apiKey))} className="w-full mt-6 py-4 bg-[#A3B18A] text-white rounded-xl shadow-md hover:bg-[#588157] transition-all font-bold flex items-center justify-center gap-2">
                                        <Icon name="award" size={18} /> 获取 AI 森林鼓励
                                    </button>
                                ) : (
                                    <div className="mt-6 p-4 bg-[#F2F4ED] rounded-xl text-center text-xs text-[#A3B18A] italic">
                                        今日全勤达成，坚持就是最好的馈赠。
                                    </div>
                                )
                            )}
                        </section>

                        <section className="bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE]">
                            <h3 className="font-serif text-lg text-[#344E41] mb-6">时光足迹</h3>
                            <div className="grid grid-cols-6 gap-3 mb-8">
                                {[...Array(30)].map((_, i) => {
                                    const rec = dailyRecords[`day_${i}`];
                                    const completed = rec?.tasks.filter(Boolean).length || 0;
                                    const isFuture = i > currentDay;
                                    let bg = i === currentDay ? 'ring-2 ring-[#A3B18A] bg-white' : (completed === 3 ? 'bg-[#588157] text-white' : (completed > 0 ? 'bg-[#A3B18A]/60' : (isFuture ? 'bg-[#DAD7CD]/20' : 'bg-[#BDBDBA]/50')));
                                    return (
                                        <div key={i} className="flex flex-col items-center gap-1">
                                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-[10px] font-bold transition-all ${bg} ${completed === 3 ? 'text-white' : 'text-[#6B705C]'}`}>{i + 1}</div>
                                            {i === currentDay && <span className="text-[9px] text-[#A3B18A] font-bold">{todayTotalTime}m</span>}
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-[#E2E8CE]/30 p-4 rounded-2xl"><p className="text-[10px] font-bold text-[#A3B18A] uppercase tracking-widest">Today 投入</p><p className="text-xl font-serif text-[#344E41]">{todayTotalTime} min</p></div>
                                <div className="bg-[#A3B18A]/10 p-4 rounded-2xl"><p className="text-[10px] font-bold text-[#A3B18A] uppercase tracking-widest">Total 投入</p><p className="text-xl font-serif text-[#344E41]">{totalTime} min</p></div>
                            </div>
                        </section>
                    </div>

                    <footer className={`bg-white/60 rounded-[2rem] p-6 border border-[#E2E8CE] transition-all duration-700 ${todayRecord.journalSubmitted ? 'opacity-70 saturate-50' : ''}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-serif text-[#344E41] text-lg">心灵留白</h3>
                            <span className="text-[10px] text-[#A3B18A]">{todayRecord.journalSubmitted ? '今日复盘已封存' : '记录你的事实、提问与结论'}</span>
                        </div>
                        <textarea readOnly={todayRecord.journalSubmitted} className="w-full h-32 bg-transparent outline-none resize-none leading-relaxed text-[#6B705C] placeholder:text-[#DAD7CD]" 
                                  placeholder="在这里存入今日的森林回忆..." value={todayRecord.journal} onChange={e => updateToday({ journal: e.target.value })} />
                        <div className="flex justify-end mt-4">
                            <button disabled={todayRecord.journalSubmitted} onClick={() => { updateToday({ journalSubmitted: true }); setModalContent("你的文字已化作养分，存入森林深处。"); }}
                                    className={`px-8 py-2.5 rounded-full text-sm flex items-center gap-2 transition-all shadow-md ${todayRecord.journalSubmitted ? 'bg-[#DAD7CD] text-[#6B705C] cursor-not-allowed shadow-none' : 'bg-[#344E41] text-white hover:bg-[#3A5A40] shadow-[#344E41]/20'}`}>
                                <Icon name={todayRecord.journalSubmitted ? "lock" : "send"} size={14} /> {todayRecord.journalSubmitted ? '已存入' : '存入森林'}
                            </button>
                        </div>
                    </footer>

                    {/* 设置弹窗 */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-6">
                            <div className="absolute inset-0 bg-[#344E41]/20 backdrop-blur-sm" onClick={() => setIsSettingsOpen(false)} />
                            <div className="bg-white p-8 rounded-[2rem] max-w-sm w-full shadow-2xl relative animate-in zoom-in-95 duration-200">
                                <h4 className="text-xl font-serif text-[#344E41] mb-6 flex items-center gap-2"><Icon name="settings" size={20} /> 系统设置</h4>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs uppercase tracking-widest text-[#A3B18A] mb-2 font-bold">API Key</label>
                                        <input 
                                            type="password" 
                                            placeholder="输入你的 Gemini API Key" 
                                            className="w-full bg-[#FDFCF8] rounded-xl px-4 py-3 border border-[#DAD7CD] outline-none focus:ring-1 focus:ring-[#A3B18A]"
                                            value={tempApiKey} 
                                            onChange={e => setTempApiKey(e.target.value)} 
                                        />
                                        <p className="mt-2 text-[10px] text-[#A3B18A] leading-relaxed italic">填写 Key 后解锁 AI 森林密语与深度报告功能。</p>
                                    </div>
                                    <button onClick={saveSettings} className="w-full py-3 bg-[#588157] text-white rounded-xl font-bold hover:bg-[#344E41] transition-all">保存设置</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 历史回溯 ---
        function HistoryView({ dailyRecords, userData, onBack }) { 
            const [selectedDay, setSelectedDay] = useState(0);
            const record = dailyRecords[`day_${selectedDay}`];
            return (
                <div className="max-w-4xl mx-auto px-6 py-12 min-h-screen animate-in fade-in duration-500">
                    <button onClick={onBack} className="flex items-center gap-2 text-[#A3B18A] hover:text-[#588157] mb-10 transition-colors font-medium">
                        <Icon name="arrow-left" size={20} /> 返回森林主场
                    </button>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                        <div className="space-y-4">
                            <h2 className="text-2xl font-serif text-[#344E41] mb-6">时光回响</h2>
                            <div className="grid grid-cols-5 gap-3">
                                {[...Array(30)].map((_, i) => (
                                    <button key={i} onClick={() => setSelectedDay(i)}
                                            className={`w-full aspect-square rounded-xl flex items-center justify-center text-xs transition-all ${selectedDay === i ? 'bg-[#344E41] text-white scale-105 shadow-lg' : 'bg-[#E2E8CE]/40 text-[#6B705C] hover:bg-[#E2E8CE]'}`}>
                                        {i + 1}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="md:col-span-2 bg-white/80 backdrop-blur-sm rounded-3xl p-8 border border-[#E2E8CE] shadow-sm">
                            {record ? (
                                <div className="space-y-8 animate-in fade-in slide-in-from-right-4">
                                    <div className="flex justify-between border-b border-[#F0F0F0] pb-4 items-end">
                                        <span className="text-xl font-serif text-[#344E41]">DAY {selectedDay + 1} 定格</span>
                                        <span className="text-xs text-[#A3B18A]">共投入 {record.times.reduce((a,b)=>a+Number(b),0)} 分钟</span>
                                    </div>
                                    <div className="space-y-4">
                                        {userData.tasks.map((task, idx) => (
                                            <div key={idx} className="flex flex-col gap-1 p-3 rounded-xl bg-[#FDFCF8]/50 border border-[#E2E8CE]/30">
                                                <div className="flex items-center gap-2">
                                                    <Icon name={record.tasks[idx] ? "check-circle-2" : "circle"} size={18} className={record.tasks[idx] ? "text-[#588157]" : "text-[#DAD7CD]"} />
                                                    <span className={`text-sm font-medium ${record.tasks[idx] ? 'text-[#344E41]' : 'text-[#DAD7CD]'}`}>{task.name}</span>
                                                </div>
                                                <div className="pl-7 text-[10px] text-[#A3B18A]">专注时长: {record.times[idx] || 0} min</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="pt-6 border-t border-[#F0F0F0]">
                                        <p className="text-xs uppercase text-[#A3B18A] mb-3 tracking-widest font-bold">当日留白</p>
                                        <p className="text-[#6B705C] leading-relaxed italic text-sm">“{record.journal || "那天没有留下文字。"}”</p>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center justify-center h-full text-[#DAD7CD] py-20">
                                    <Icon name="calendar" size={48} className="mb-4 opacity-50" />
                                    <p>时光尚未流经此处</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 终极报告 ---
        function FinalReport({ userData, dailyRecords, onReset }) { 
            const [report, setReport] = useState("");
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const generateFinalReport = async () => {
                    const summary = Object.entries(dailyRecords).map(([day, rec]) => {
                        return `${day}: 任务完成[${rec.tasks.filter(Boolean).length}/3], 投入[${rec.times.reduce((a,b)=>a+Number(b),0)}min]`;
                    }).join("\n");
                    
                    if (userData.apiKey) {
                        const prompt = `用户完成了30天成长计划。历程摘要：\n${summary}\n\n请写一份长篇深度心理复盘报告。以极其温柔的心理咨询师口吻。`;
                        const result = await fetchAI(prompt, userData.apiKey);
                        setReport(result);
                    } else {
                        setReport("恭喜你完成了 30 天的成长旅程。这棵树见证了你的每一次坚持与努力。每一份‘心灵留白’都是最真实的成长注脚。");
                    }
                    setLoading(false);
                };
                generateFinalReport();
            }, []);

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center text-center p-10 font-serif"><div className="w-12 h-12 border-4 border-[#A3B18A] border-t-transparent rounded-full animate-spin mb-6" /><p className="text-[#6B705C] animate-pulse">正在回顾你的 30 天时光森林...</p></div>;

            return (
                <div className="max-w-3xl mx-auto py-16 px-6 animate-in fade-in duration-1000">
                    <div className="bg-white p-12 rounded-[3rem] shadow-xl border border-[#E2E8CE] relative overflow-hidden">
                        <h2 className="text-3xl font-serif text-[#344E41] mb-8">30天成长见证报告</h2>
                        <div className="prose prose-stone max-w-none text-[#6B705C] leading-loose whitespace-pre-wrap italic">
                            {report}
                        </div>
                        <div className="mt-16 pt-8 border-t border-[#F0F0F0] flex flex-col items-center">
                            <button onClick={onReset} className="px-10 py-4 bg-[#344E41] text-white rounded-2xl hover:bg-[#3A5A40] transition-all shadow-lg font-bold tracking-widest uppercase">开启新旅程</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>